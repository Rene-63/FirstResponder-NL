// ==UserScript==
// @name        * Ersthelfer
// @namespace   bos-ernie.leitstellenspiel.de
// @version     1.0.0
// @license     BSD-3-Clause
// @author      BOS-Ernie
// @description Wählt das nächstliegende Ersthelferfahrzeug aus
// @match       https://*.leitstellenspiel.de/missions/*
// @icon        https://www.google.com/s2/favicons?sz=64&domain=leitstellenspiel.de
// @run-at      document-idle
// @grant       none
// @resource    https://forum.leitstellenspiel.de/index.php?thread/25554-script-ersthelfer-by-bos-ernie/
// ==/UserScript==
 
(function () {
  /**
   * Liste der Fahrzeugtypen die als Ersthelfer ausgewöhlt werden dürfen.
   *
   * Nicht zu verwendende Fahrzeuge auskommentieren oder entfernen. Die Liste aktueller Fahrzeugtypen wird im Forum
   * gepflegt (siehe Link).
   * https://forum.leitstellenspiel.de/index.php?thread/8406-infos-f%C3%BCr-entwickler/&postID=485487#post485487
   *
   *  @type {number[]}
   */
  const firstResponderVehicleTypeIds = [
20, // DA
21, // DB-K
22, // DA Noodhulp
25, // DB Noodhulp
46, // DM Noodhulp
60, // DB-Bike

  ];
 
  function addSelectButton() {
    const icon = document.createElement("span");
    icon.classList.add("glyphicon", "glyphicon-fire");
 
    const firstResponderButton = document.createElement("button");
    firstResponderButton.classList.add("btn", "btn-primary");
    firstResponderButton.appendChild(icon);
    firstResponderButton.addEventListener("click", clickEventHandler);
    firstResponderButton.title = "Ersthelfer auswählen (Taste: f)";
 
    const wrapper = document.createElement("div");
    wrapper.classList.add("flex-row", "flex-nowrap");
    wrapper.appendChild(firstResponderButton);
 
    const iframeBottomContent = document.querySelector("#iframe-bottom-content");
    if (iframeBottomContent === null) {
      return;
    }
 
    let parent = iframeBottomContent.querySelector("#mission_alliance_share_btn");
    if (parent === null) {
      parent = iframeBottomContent.querySelector("#mission_next_mission_btn");
    }
 
    parent.parentElement.after(wrapper);
  }
 
  function clickEventHandler(event) {
    event.preventDefault();
    selectFirstResponder();
  }
 
  async function selectFirstResponder() {
    const checkboxes = document.getElementsByClassName("vehicle_checkbox");
 
    let firstResponderFound = false;
    for (let i = 0; i < checkboxes.length; i++) {
      const checkbox = checkboxes[i];
 
      if (checkbox.disabled) {
        continue;
      }
 
      if (checkbox.checked) {
        continue;
      }
 
      const vehicleTypeId = parseInt(checkbox.getAttribute("vehicle_type_id"));
      if (firstResponderVehicleTypeIds.includes(vehicleTypeId)) {
        checkbox.click();
        firstResponderFound = true;
 
        break;
      }
    }
 
    if (!firstResponderFound) {
      alert(
        "[Ersthelfer] Kein passendes Fahrzeug gefunden. Entweder Fahrzeuge nachladen oder erlaubte Fahrzeugtypen erweitern.",
      );
    }
  }
 
  function main() {
    addSelectButton();
 
    document.addEventListener("keydown", function (event) {
      if (event.key === "f") {
        selectFirstResponder();
      }
    });
  }
 
  main();
})();
